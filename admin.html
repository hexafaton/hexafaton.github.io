<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin | Hexafaton CMS</title>

  <!-- 🔗 Fonts & CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="assets/css/admin.css" />

  <!-- 🔗 Konfigurasi API -->
  <script src="config.js"></script>
</head>
<body>
  <!-- 🔐 Cek Login -->
  <script>
    // GUNAKAN SESSION STORAGE, BUKAN LOCAL
    if (sessionStorage.getItem("hexafaton_admin_session") !== "true") {
      window.location.href = "login.html";
    }
  </script>

  <!-- 🔹 Header -->
  <header>
    <div class="navbar">
      <a href="index.html" class="logo-link" title="Kembali ke Beranda">
        <img src="assets/img/logo.png" alt="Hexafaton Logo" class="logo">
      </a>
      <div class="nav-title">
        <h1>✏️ Admin Panel Hexafaton</h1>
        <p>Kelola artikel dengan mudah dan aman</p>
      </div>
      <button onclick="logout()">🚪 Logout</button>
    </div>
  </header>

  <!-- 🔹 Form Tambah / Edit Artikel -->
  <form id="articleForm" enctype="multipart/form-data">
    <input type="hidden" id="articleId" />
    
    <label for="title">Judul Artikel</label>
    <input type="text" id="title" placeholder="Masukkan judul artikel" required />

    <label for="content">Isi Artikel</label>
    <textarea id="content" placeholder="Tulis isi artikel di sini..." required></textarea>

    <label for="image">Gambar Artikel (opsional)</label>
    <input type="file" id="image" accept="image/*" />
    <div id="previewContainer" style="margin-top:10px;">
      <img id="previewImage" src="" alt="Preview" style="max-width:200px;display:none;border-radius:8px;">
    </div>

    <div class="form-actions">
      <button type="submit">💾 Simpan</button>
      <button type="button" id="cancelEdit" class="secondary" style="display:none;">Batal</button>
    </div>

    <div class="status" id="status"></div>
  </form>

  <!-- 🔹 Daftar Artikel -->
  <section class="article-list">
    <h2>📰 Daftar Artikel</h2>
    <div id="listContainer">⏳ Memuat data...</div>
  </section>

  <!-- 🔹 Footer -->
  <footer>
    <p>© 2025 Hexafaton | Dibangun dengan ❤️ dan GitHub Pages</p>
  </footer>

  <!-- ======================= SCRIPT ======================= -->
  <script>
    const form = document.getElementById("articleForm");
    const listContainer = document.getElementById("listContainer");
    const cancelEditBtn = document.getElementById("cancelEdit");
    const status = document.getElementById("status");
    const imageInput = document.getElementById("image");
    const previewImage = document.getElementById("previewImage");

    // 🖼️ Preview gambar sebelum upload
    imageInput.addEventListener("change", () => {
      const file = imageInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImage.src = e.target.result;
          previewImage.style.display = "block";
        };
        reader.readAsDataURL(file);
      } else {
        previewImage.style.display = "none";
      }
    });

    // 🔄 Muat Semua Artikel
    async function loadArticles() {
      listContainer.innerHTML = "⏳ Memuat artikel...";
      try {
        const res = await fetch(API_URL + "/api/articles");
        const data = await res.json();

        if (!data.length) {
          listContainer.innerHTML = "<p>Belum ada artikel.</p>";
          return;
        }

        listContainer.innerHTML = "";
        data.forEach((a) => {
          const div = document.createElement("div");
          div.className = "article-item";
          div.innerHTML = `
            ${a.image ? `<img src="${a.image}" alt="${a.title}" style="max-width:100px;border-radius:6px;">` : ""}
            <h3>${a.title}</h3>
            <p>${a.content.substring(0, 120)}...</p>
            <div class="actions">
              <button class="edit" onclick="editArticle('${a.id}')">✏️ Edit</button>
              <button class="delete" onclick="deleteArticle('${a.id}')">🗑️ Hapus</button>
            </div>
          `;
          listContainer.appendChild(div);
        });
      } catch (err) {
        listContainer.innerHTML = "❌ Gagal memuat artikel.";
        console.error(err);
      }
    }

    // 💾 Tambah atau Update Artikel
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      status.textContent = "⏳ Menyimpan...";
      let imageUrl = "";

      const imageFile = imageInput.files[0];
      if (imageFile) {
        const formData = new FormData();
        formData.append("file", imageFile);
        try {
          const uploadRes = await fetch(API_URL + "/api/upload", { method: "POST", body: formData });
          const uploadData = await uploadRes.json();
          imageUrl = uploadData.url;
        } catch (err) {
          console.error("Upload gagal:", err);
          status.textContent = "⚠️ Upload gambar gagal.";
        }
      }

      const id = document.getElementById("articleId").value || Date.now().toString();
      const data = {
        id,
        title: document.getElementById("title").value.trim(),
        content: document.getElementById("content").value.trim(),
        image: imageUrl,
        date: new Date().toISOString(),
      };

      try {
        const res = await fetch(API_URL + "/api/articles", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        if (res.ok) {
          status.textContent = "✅ Artikel berhasil disimpan!";
          form.reset();
          previewImage.style.display = "none";
          cancelEditBtn.style.display = "none";
          loadArticles();
        } else {
          status.textContent = "❌ Gagal menyimpan artikel.";
        }
      } catch (err) {
        status.textContent = "⚠️ Terjadi kesalahan jaringan.";
        console.error(err);
      }
    });

    // ✏️ Edit Artikel
    window.editArticle = async (id) => {
      try {
        const res = await fetch(API_URL + "/api/articles");
        const data = await res.json();
        const article = data.find((a) => a.id === id);
        if (!article) return alert("Artikel tidak ditemukan!");

        document.getElementById("articleId").value = article.id;
        document.getElementById("title").value = article.title;
        document.getElementById("content").value = article.content;
        if (article.image) {
          previewImage.src = article.image;
          previewImage.style.display = "block";
        }
        cancelEditBtn.style.display = "inline-block";
      } catch (err) {
        console.error(err);
      }
    };

    // 🔙 Batal Edit
    cancelEditBtn.addEventListener("click", () => {
      form.reset();
      document.getElementById("articleId").value = "";
      previewImage.style.display = "none";
      cancelEditBtn.style.display = "none";
    });

    // 🗑️ Hapus Artikel
    window.deleteArticle = async (id) => {
      if (!confirm("Yakin ingin menghapus artikel ini?")) return;
      try {
        const res = await fetch(API_URL + "/api/delete?id=" + id, { method: "DELETE" });
        if (res.ok) {
          alert("🗑️ Artikel dihapus!");
          loadArticles();
        } else {
          alert("❌ Gagal menghapus artikel.");
        }
      } catch (err) {
        alert("⚠️ Terjadi kesalahan jaringan.");
        console.error(err);
      }
    };

    // 🚪 Logout
    function logout() {
      sessionStorage.removeItem("hexafaton_admin_session"); // ✅ ganti dari localStorage
      window.location.href = "login.html";
    }

    // 🚀 Jalankan saat halaman dibuka
    loadArticles();
  </script>
</body>
</html>
